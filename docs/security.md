# 🔐 セキュリティドキュメント

本ドキュメントは、Excel チャットボットアプリケーションに実装されたセキュリティ機能について詳述します。

## 🛡️ 実装されたセキュリティ機能

### 1. **認証・認可システム**

#### JWT (JSON Web Token)
- **アクセストークン**: 15分の有効期限
- **リフレッシュトークン**: 7日間の有効期限、HTTPOnlyクッキーで保護
- **トークン検証**: 署名検証とペイロード検証
- **ロールベースアクセス制御**: user, premium, admin

#### パスワードセキュリティ
- **bcrypt暗号化**: 12ラウンド（設定可能）
- **強力なパスワード要件**: 大文字、小文字、数字、特殊文字
- **アカウントロック**: 5回失敗で2時間ロック

### 2. **入力検証・サニタイゼーション**

#### XSS (Cross-Site Scripting) 対策
- **DOMPurify**: HTMLタグの完全除去
- **文字エスケープ**: `<`, `>`, `"`, `'`, `/` のエスケープ
- **制御文字除去**: 制御文字の自動削除

#### SQLインジェクション対策
- **パターン検出**: 危険なSQLパターンの検出
- **入力サニタイゼーション**: すべての入力の自動サニタイゼーション
- **パラメータ化クエリ**: MongoDBのパラメータ化クエリ使用

#### 入力制限
- **文字数制限**: メッセージ5000文字、ユーザー名30文字
- **ファイルサイズ制限**: 最大10MB
- **許可ファイル形式**: Excel, CSV, 画像のみ

### 3. **セッション管理**

#### セキュアセッション設定
- **HTTPOnly**: JavaScriptからのアクセス不可
- **Secure**: HTTPS必須（本番環境）
- **SameSite**: Strict設定でCSRF対策
- **セッション有効期限**: 24時間

#### セッション保護
- **セッション再生成**: ログイン時に新しいセッション
- **セッション無効化**: ログアウト時の完全削除
- **セッション検証**: ユーザーとの一致確認

### 4. **CSRF (Cross-Site Request Forgery) 対策**

#### 複数層防御
- **CSRFトークン**: 動的トークン生成・検証
- **SameSiteクッキー**: クロスオリジンリクエスト制御
- **Refererチェック**: リクエスト元の検証
- **カスタムヘッダー**: X-Requested-With検証

### 5. **レート制限**

#### API保護
- **一般API**: 15分間に100リクエスト
- **認証API**: 15分間に5リクエスト
- **チャットAPI**: 1分間に10メッセージ
- **IP制限**: 24時間に1000リクエスト

#### 段階的制限
- **スローダウン**: 50リクエスト後500ms遅延
- **ユーザー別制限**: 認証ユーザーの個別制限
- **使用量追跡**: 日次・月次制限

### 6. **セキュリティヘッダー**

#### Helmet.js設定
- **Content-Security-Policy**: XSS対策
- **X-Frame-Options**: DENY（クリックジャッキング対策）
- **X-Content-Type-Options**: nosniff
- **Referrer-Policy**: strict-origin-when-cross-origin
- **Permissions-Policy**: 不要な機能の無効化

#### カスタムヘッダー
- **X-XSS-Protection**: 古いブラウザ対応
- **X-Security-Policy**: アプリケーション識別

### 7. **ログ記録・監査**

#### 包括的ログ記録
- **認証イベント**: ログイン/ログアウト/失敗
- **API呼び出し**: 全APIアクセスの記録
- **セキュリティイベント**: 攻撃試行の検出
- **ユーザーアクション**: 重要な操作の記録

#### ログ分析
- **異常検知**: 不審なアクセスパターン
- **パフォーマンス監視**: レスポンス時間追跡
- **エラー追跡**: システムエラーの記録

### 8. **WebSocket セキュリティ**

#### 接続認証
- **JWT認証**: WebSocket接続時の認証
- **ユーザー検証**: 有効なユーザーのみ接続許可
- **セッション管理**: 接続状態の管理

#### メッセージ保護
- **入力検証**: WebSocketメッセージの検証
- **レート制限**: メッセージ送信制限
- **ルーム管理**: 適切なルーム分離

## 🚨 脅威モデル

### 対策済み脅威
1. **XSS攻撃**: 入力サニタイゼーション、CSP
2. **SQLインジェクション**: パラメータ化クエリ、入力検証
3. **CSRF攻撃**: トークン検証、SameSiteクッキー
4. **ブルートフォース攻撃**: レート制限、アカウントロック
5. **セッションハイジャック**: セキュアセッション設定
6. **クリックジャッキング**: X-Frame-Options DENY
7. **情報漏洩**: エラーハンドリング、ログマスキング

### 残存リスク
1. **DDoS攻撃**: 上位レベルでの対策が必要
2. **物理的アクセス**: サーバー物理セキュリティ
3. **内部脅威**: 管理者アクセスの監視
4. **ゼロデイ脆弱性**: 依存関係の定期更新

## 🔧 セキュリティ設定

### 環境変数（必須）
```bash
# JWT設定
JWT_SECRET=your-super-secure-jwt-secret-key
JWT_REFRESH_SECRET=your-refresh-secret-key

# セッション設定
SESSION_SECRET=your-session-secret-key

# パスワード暗号化
BCRYPT_ROUNDS=12

# CSRF設定
CSRF_SECRET=your-csrf-secret-key

# CORS設定
ALLOWED_ORIGINS=https://yourdomain.com
```

### 本番環境推奨設定
```bash
NODE_ENV=production
SSL_KEY_PATH=/path/to/ssl/key
SSL_CERT_PATH=/path/to/ssl/cert
RATE_LIMIT_WINDOW_MS=900000
RATE_LIMIT_MAX_REQUESTS=50
```

## 📊 セキュリティ監視

### 監視項目
- **失敗した認証試行**
- **異常なAPI使用パターン**
- **不審なWebSocket接続**
- **エラー率の急増**
- **レスポンス時間の異常**

### アラート設定
- **連続ログイン失敗**: 5回/IP
- **高レート制限**: 制限到達時
- **セキュリティ違反**: 即座にアラート
- **システムエラー**: 重要度に応じてアラート

## 🔄 定期メンテナンス

### セキュリティタスク
- **依存関係更新**: 月次
- **ログローテーション**: 日次
- **セキュリティ監査**: 四半期
- **脆弱性スキャン**: 月次

### 推奨ツール
- **npm audit**: 依存関係の脆弱性チェック
- **ESLint**: コード品質チェック
- **OWASP ZAP**: セキュリティテスト
- **Snyk**: 継続的セキュリティ監視

## 📋 インシデント対応

### 対応手順
1. **検出**: 監視システムによる自動検出
2. **分析**: ログ分析によるインシデント確認
3. **対応**: 影響範囲の特定と対策実施
4. **復旧**: システムの正常化
5. **事後対応**: 原因分析と再発防止策

### 連絡先
- **セキュリティ担当**: security@excel-chatbot.com
- **緊急時**: emergency@excel-chatbot.com

## 🎯 今後の改善計画

### 短期（1-3ヶ月）
- [ ] 二要素認証の実装
- [ ] API Gateway導入
- [ ] WAF設定

### 中期（3-6ヶ月）
- [ ] 侵入検知システム
- [ ] 暗号化キー管理システム
- [ ] セキュリティ情報イベント管理

### 長期（6-12ヶ月）
- [ ] ゼロトラスト・アーキテクチャ
- [ ] 機械学習による異常検知
- [ ] 量子耐性暗号の準備

---

**最終更新**: 2024年8月25日  
**バージョン**: 1.0.0  
**作成者**: Excel ChatBot セキュリティチーム